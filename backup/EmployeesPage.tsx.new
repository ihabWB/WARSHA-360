import React, { useState, useEffect } from 'react';
import { useAppContext } from '../context/AppContext';
import { supabase } from '../lib/supabase';
import { Users, Mail, Shield, Clock, CheckCircle, XCircle, UserPlus, Edit, Trash2, Ban, Check } from 'lucide-react';
import Modal from '../components/Modal';

interface PreRegisteredUser {
  id: string;
  email: string;
  name?: string;
  role: string;
  status: 'pending' | 'activated';
  createdAt: string;
}

interface UserRoleInfo {
  id: string;
  userId: string;
  role: string;
  status: 'active' | 'suspended' | 'revoked';
  createdAt: string;
  email?: string;
  name?: string;
  lastLogin?: string;
}

const EmployeesPage: React.FC = () => {
  const { selectedKablanId, user } = useAppContext();
  const [activeTab, setActiveTab] = useState<'active' | 'pending' | 'suspended' | 'revoked'>('active');
  
  const [preRegisteredUsers, setPreRegisteredUsers] = useState<PreRegisteredUser[]>([]);
  const [userRoles, setUserRoles] = useState<UserRoleInfo[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Modals
  const [isInviteModalOpen, setIsInviteModalOpen] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [selectedEmployee, setSelectedEmployee] = useState<UserRoleInfo | null>(null);

  // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  useEffect(() => {
    if (!selectedKablanId) return;
    loadData();
  }, [selectedKablanId]);

  const loadData = async () => {
    if (!selectedKablanId) return;
    
    try {
      setLoading(true);

      // Ø¬Ù„Ø¨ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù…Ù† pre_registered_users
      const { data: preRegData, error: preRegError } = await supabase
        .from('pre_registered_users')
        .select('*')
        .eq('kablan_id', selectedKablanId)
        .eq('status', 'pending')
        .order('created_at', { ascending: false });

      if (preRegError) throw preRegError;
      setPreRegisteredUsers(preRegData || []);

      // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù€ kablan
      const { data: rolesData, error: rolesError } = await supabase
        .from('user_roles')
        .select('*')
        .eq('kablan_id', selectedKablanId)
        .order('created_at', { ascending: false});

      if (rolesError) throw rolesError;
      setUserRoles(rolesData || []);

    } catch (error: any) {
      console.error('Error loading employees:', error);
      alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  // Ø¯Ø¹ÙˆØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
  const handleInviteEmployee = async (email: string, role: string, name?: string) => {
    if (!selectedKablanId) {
      alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙƒØ¨Ù„Ø§Ù†');
      return;
    }
    
    if (!user?.id) {
      alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
      return;
    }
    
    try {
      const { error } = await supabase
        .from('pre_registered_users')
        .insert([{ 
          email: email.toLowerCase().trim(), 
          name: name?.trim() || null,
          role, 
          status: 'pending',
          kablan_id: selectedKablanId,
          registered_by: user.id
        }]);

      if (error) throw error;
      
      alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¨Ù†Ø¬Ø§Ø­!');
      setIsInviteModalOpen(false);
      loadData();
    } catch (error: any) {
      console.error('Error inviting employee:', error);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©: ' + error.message);
    }
  };

  // Ø­Ø°Ù Ø¯Ø¹ÙˆØ© Ù…Ø¹Ù„Ù‚Ø©
  const handleCancelInvitation = async (userId: string) => {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø¹ÙˆØ©ØŸ')) return;
    
    try {
      const { error } = await supabase
        .from('pre_registered_users')
        .delete()
        .eq('id', userId);

      if (error) throw error;
      
      alert('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯Ø¹ÙˆØ©');
      loadData();
    } catch (error: any) {
      console.error('Error canceling invitation:', error);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯Ø¹ÙˆØ©: ' + error.message);
    }
  };

  // ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙˆØ± Ù…ÙˆØ¸Ù
  const handleUpdateRole = async (employeeId: string, newRole: string) => {
    try {
      const { error } = await supabase
        .from('user_roles')
        .update({ role: newRole })
        .eq('id', employeeId);

      if (error) throw error;
      
      alert('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
      setIsEditModalOpen(false);
      setSelectedEmployee(null);
      loadData();
    } catch (error: any) {
      console.error('Error updating role:', error);
      alert('Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±: ' + error.message);
    }
  };

  // ØªØ¹Ù„ÙŠÙ‚/ØªÙØ¹ÙŠÙ„ Ù…ÙˆØ¸Ù
  const handleToggleSuspend = async (employeeId: string, currentStatus: string) => {
    const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
    const action = newStatus === 'suspended' ? 'ØªØ¹Ù„ÙŠÙ‚' : 'ØªÙØ¹ÙŠÙ„';
    
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${action} Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ`)) return;
    
    try {
      const { error } = await supabase
        .from('user_roles')
        .update({ status: newStatus })
        .eq('id', employeeId);

      if (error) throw error;
      
      alert(`âœ… ØªÙ… ${action} Ø§Ù„Ù…ÙˆØ¸Ù`);
      loadData();
    } catch (error: any) {
      console.error('Error toggling suspend:', error);
      alert(`Ø®Ø·Ø£ ÙÙŠ ${action} Ø§Ù„Ù…ÙˆØ¸Ù: ` + error.message);
    }
  };

  // Ø­Ø°Ù Ù…ÙˆØ¸Ù (ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ revoked)
  const handleRevokeEmployee = async (employeeId: string) => {
    if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ\nØ³ÙŠØªÙ… Ù…Ù†Ø¹Ù‡ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø¯Ø¹ÙˆØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹.')) return;
    
    try {
      const { error } = await supabase
        .from('user_roles')
        .update({ status: 'revoked' })
        .eq('id', employeeId);

      if (error) throw error;
      
      alert('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù');
      loadData();
    } catch (error: any) {
      console.error('Error revoking employee:', error);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù: ' + error.message);
    }
  };

  // Ø¥Ø¹Ø§Ø¯Ø© Ø¯Ø¹ÙˆØ© Ù…ÙˆØ¸Ù Ù…Ø­Ø°ÙˆÙ (revoked)
  const handleReinviteEmployee = async (employeeEmail: string, employeeName?: string) => {
    if (!selectedKablanId || !user?.id) return;
    
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ø¹ÙˆØ© Ù…Ø¹Ù„Ù‚Ø©
      const { data: existingInvite } = await supabase
        .from('pre_registered_users')
        .select('*')
        .eq('email', employeeEmail)
        .eq('kablan_id', selectedKablanId)
        .single();

      if (existingInvite) {
        alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¯ÙŠÙ‡ Ø¯Ø¹ÙˆØ© Ù…Ø¹Ù„Ù‚Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
        return;
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø¹ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯ÙˆØ± viewer ÙƒØ¥ÙØªØ±Ø§Ø¶ÙŠ
      const { error } = await supabase
        .from('pre_registered_users')
        .insert([{
          email: employeeEmail.toLowerCase().trim(),
          name: employeeName || null,
          role: 'viewer',
          status: 'pending',
          kablan_id: selectedKablanId,
          registered_by: user.id
        }]);

      if (error) throw error;

      alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…ÙˆØ¸Ù!\nØ¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ù‡ Ø§Ù„ØªØ§Ù„ÙŠØŒ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.');
      loadData();
    } catch (error: any) {
      console.error('Error reinviting employee:', error);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©: ' + error.message);
    }
  };

  // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  const activeEmployees = userRoles.filter(u => u.status === 'active');
  const suspendedEmployees = userRoles.filter(u => u.status === 'suspended');
  const revokedEmployees = userRoles.filter(u => u.status === 'revoked');

  // ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
  const getRoleLabel = (role: string) => {
    const labels: Record<string, string> = {
      owner: 'ğŸ‘‘ Ù…Ø§Ù„Ùƒ',
      admin: 'âš™ï¸ Ù…Ø¯ÙŠØ±',
      accountant: 'ğŸ’° Ù…Ø­Ø§Ø³Ø¨',
      data_entry: 'ğŸ“ Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª',
      viewer: 'ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯',
    };
    return labels[role] || role;
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-xl text-gray-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    );
  }

  return (
    <div className="p-8">
      <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
        {/* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */}
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <Users size={32} className="text-blue-600" />
            <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-100">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
          </div>
          <button
            onClick={() => setIsInviteModalOpen(true)}
            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center gap-2"
          >
            <UserPlus size={20} />
            <span>Ø¯Ø¹ÙˆØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</span>
          </button>
        </div>

        {/* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */}
        <div className="flex border-b mb-6">
          <button
            onClick={() => setActiveTab('active')}
            className={`py-3 px-6 transition-colors duration-200 ${
              activeTab === 'active'
                ? 'border-b-2 border-blue-600 text-blue-600 font-semibold'
                : 'text-gray-500 hover:text-blue-500'
            }`}
          >
            <div className="flex items-center gap-2">
              <CheckCircle size={20} />
              <span>Ù…ÙˆØ¸ÙÙŠÙ† Ù†Ø´Ø·ÙŠÙ† ({activeEmployees.length})</span>
            </div>
          </button>
          
          <button
            onClick={() => setActiveTab('pending')}
            className={`py-3 px-6 transition-colors duration-200 ${
              activeTab === 'pending'
                ? 'border-b-2 border-blue-600 text-blue-600 font-semibold'
                : 'text-gray-500 hover:text-blue-500'
            }`}
          >
            <div className="flex items-center gap-2">
              <Clock size={20} />
              <span>Ø¯Ø¹ÙˆØ§Øª Ù…Ø¹Ù„Ù‚Ø© ({preRegisteredUsers.length})</span>
            </div>
          </button>

          <button
            onClick={() => setActiveTab('suspended')}
            className={`py-3 px-6 transition-colors duration-200 ${
              activeTab === 'suspended'
                ? 'border-b-2 border-blue-600 text-blue-600 font-semibold'
                : 'text-gray-500 hover:text-blue-500'
            }`}
          >
            <div className="flex items-center gap-2">
              <Ban size={20} />
              <span>Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø¹Ù„Ù‚ÙŠÙ† ({suspendedEmployees.length})</span>
            </div>
          </button>

          <button
            onClick={() => setActiveTab('revoked')}
            className={`py-3 px-6 transition-colors duration-200 ${
              activeTab === 'revoked'
                ? 'border-b-2 border-blue-600 text-blue-600 font-semibold'
                : 'text-gray-500 hover:text-blue-500'
            }`}
          >
            <div className="flex items-center gap-2">
              <XCircle size={20} />
              <span>Ù…Ø­Ø°ÙˆÙÙŠÙ† ({revokedEmployees.length})</span>
            </div>
          </button>
        </div>

        {/* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */}
        {activeTab === 'pending' && (
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">
              Ø¯Ø¹ÙˆØ§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            </h2>
            {preRegisteredUsers.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <Mail size={48} className="mx-auto mb-4 opacity-50" />
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ù…Ø¹Ù„Ù‚Ø©</p>
              </div>
            ) : (
              <div className="grid gap-4">
                {preRegisteredUsers.map((user) => (
                  <div
                    key={user.id}
                    className="border dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition"
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        <Mail size={24} className="text-blue-500" />
                        <div>
                          <p className="font-semibold text-gray-800 dark:text-gray-100">
                            {user.name || user.email}
                          </p>
                          {user.name && (
                            <p className="text-sm text-gray-600 dark:text-gray-400">{user.email}</p>
                          )}
                          <p className="text-sm text-gray-500 dark:text-gray-400">
                            {getRoleLabel(user.role)} â€¢ Ø¯ÙØ¹ÙŠ ÙÙŠ {new Date(user.createdAt).toLocaleDateString('ar-EG')}
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-3 py-1 rounded-full text-sm">
                          â³ Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¨Ø¹Ø¯
                        </span>
                        <button
                          onClick={() => handleCancelInvitation(user.id)}
                          className="text-red-600 hover:text-red-800 p-2"
                          title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯Ø¹ÙˆØ©"
                        >
                          <Trash2 size={18} />
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {activeTab === 'active' && (
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">
              Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
            </h2>
            {activeEmployees.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <Users size={48} className="mx-auto mb-4 opacity-50" />
                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù†Ø´Ø·ÙŠÙ†</p>
              </div>
            ) : (
              <div className="grid gap-4">
                {activeEmployees.map((employee) => (
                  <div
                    key={employee.id}
                    className="border dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition"
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        <div className="bg-green-100 dark:bg-green-900 p-3 rounded-full">
                          <Shield size={24} className="text-green-600 dark:text-green-300" />
                        </div>
                        <div>
                          <p className="font-semibold text-gray-800 dark:text-gray-100">
                            {employee.name || employee.email || employee.userId}
                          </p>
                          {employee.name && employee.email && (
                            <p className="text-sm text-gray-600 dark:text-gray-400">{employee.email}</p>
                          )}
                          <p className="text-sm text-gray-500 dark:text-gray-400">
                            {getRoleLabel(employee.role)} â€¢ Ø§Ù†Ø¶Ù… ÙÙŠ {new Date(employee.createdAt).toLocaleDateString('ar-EG')}
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm">
                          âœ“ Ù†Ø´Ø·
                        </span>
                        <button
                          onClick={() => {
                            setSelectedEmployee(employee);
                            setIsEditModalOpen(true);
                          }}
                          className="text-blue-600 hover:text-blue-800 p-2"
                          title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±"
                        >
                          <Edit size={18} />
                        </button>
                        <button
                          onClick={() => handleToggleSuspend(employee.id, employee.status)}
                          className="text-yellow-600 hover:text-yellow-800 p-2"
                          title="ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨"
                        >
                          <Ban size={18} />
                        </button>
                        <button
                          onClick={() => handleRevokeEmployee(employee.id)}
                          className="text-red-600 hover:text-red-800 p-2"
                          title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª"
                        >
                          <Trash2 size={18} />
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {activeTab === 'suspended' && (
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">
              Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø¹Ù„Ù‚ÙŠÙ†
            </h2>
            {suspendedEmployees.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <XCircle size={48} className="mx-auto mb-4 opacity-50" />
                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø¹Ù„Ù‚ÙŠÙ†</p>
              </div>
            ) : (
              <div className="grid gap-4">
                {suspendedEmployees.map((employee) => (
                  <div
                    key={employee.id}
                    className="border dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition bg-gray-50 dark:bg-gray-900"
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        <div className="bg-red-100 dark:bg-red-900 p-3 rounded-full">
                          <XCircle size={24} className="text-red-600 dark:text-red-300" />
                        </div>
                        <div>
                          <p className="font-semibold text-gray-800 dark:text-gray-100">
                            {employee.name || employee.email || employee.userId}
                          </p>
                          {employee.name && employee.email && (
                            <p className="text-sm text-gray-600 dark:text-gray-400">{employee.email}</p>
                          )}
                          <p className="text-sm text-gray-500 dark:text-gray-400">
                            {getRoleLabel(employee.role)} â€¢ Ù…ÙØ¹Ù„Ù‚
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-3 py-1 rounded-full text-sm">
                          ğŸš« Ù…Ø¹Ù„Ù‚
                        </span>
                        <button
                          onClick={() => handleToggleSuspend(employee.id, employee.status)}
                          className="text-green-600 hover:text-green-800 p-2"
                          title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨"
                        >
                          <Check size={18} />
                        </button>
                        <button
                          onClick={() => handleRevokeEmployee(employee.id)}
                          className="text-red-600 hover:text-red-800 p-2"
                          title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹"
                        >
                          <Trash2 size={18} />
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {activeTab === 'revoked' && (
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">
              Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø­Ø°ÙˆÙÙŠÙ† (ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø¯Ø¹ÙˆØªÙ‡Ù…)
            </h2>
            {revokedEmployees.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <XCircle size={48} className="mx-auto mb-4 opacity-50" />
                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø­Ø°ÙˆÙÙŠÙ†</p>
              </div>
            ) : (
              <div className="grid gap-4">
                {revokedEmployees.map((employee) => (
                  <div
                    key={employee.id}
                    className="border dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition bg-gray-100 dark:bg-gray-800 opacity-75"
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        <div className="bg-gray-300 dark:bg-gray-600 p-3 rounded-full">
                          <XCircle size={24} className="text-gray-600 dark:text-gray-400" />
                        </div>
                        <div>
                          <p className="font-semibold text-gray-800 dark:text-gray-100">
                            {employee.name || employee.email || employee.userId}
                          </p>
                          {employee.name && employee.email && (
                            <p className="text-sm text-gray-600 dark:text-gray-400">{employee.email}</p>
                          )}
                          <p className="text-sm text-gray-500 dark:text-gray-400">
                            {getRoleLabel(employee.role)} â€¢ ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-full text-sm">
                          âŒ Ù…Ø­Ø°ÙˆÙ
                        </span>
                        <button
                          onClick={() => handleReinviteEmployee(employee.email || '', employee.name)}
                          className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center gap-2"
                          title="Ø¥Ø¹Ø§Ø¯Ø© Ø¯Ø¹ÙˆØ© Ø§Ù„Ù…ÙˆØ¸Ù"
                        >
                          <UserPlus size={18} />
                          <span>Ø¥Ø¹Ø§Ø¯Ø© Ø¯Ø¹ÙˆØ©</span>
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>

      {/* Modal Ø¯Ø¹ÙˆØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯ */}
      <InviteEmployeeModal
        isOpen={isInviteModalOpen}
        onClose={() => setIsInviteModalOpen(false)}
        onInvite={handleInviteEmployee}
      />

      {/* Modal ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙˆØ± */}
      <EditRoleModal
        isOpen={isEditModalOpen}
        onClose={() => {
          setIsEditModalOpen(false);
          setSelectedEmployee(null);
        }}
        employee={selectedEmployee}
        onUpdate={handleUpdateRole}
      />
    </div>
  );
};

// Modal Ø¯Ø¹ÙˆØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
interface InviteEmployeeModalProps {
  isOpen: boolean;
  onClose: () => void;
  onInvite: (email: string, role: string, name?: string) => void;
}

const InviteEmployeeModal: React.FC<InviteEmployeeModalProps> = ({ isOpen, onClose, onInvite }) => {
  const [email, setEmail] = useState('');
  const [name, setName] = useState('');
  const [role, setRole] = useState('viewer');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!email.trim()) {
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
      return;
    }
    onInvite(email, role, name);
    setEmail('');
    setName('');
    setRole('viewer');
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Ø¯Ø¹ÙˆØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 p-2 rounded-md focus:ring-2 focus:ring-blue-500"
            placeholder="Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
          </label>
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 p-2 rounded-md focus:ring-2 focus:ring-blue-500"
            placeholder="employee@example.com"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Ø§Ù„Ø¯ÙˆØ±
          </label>
          <select
            value={role}
            onChange={(e) => setRole(e.target.value)}
            className="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 p-2 rounded-md"
          >
            <option value="viewer">ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯ - Ø¹Ø±Ø¶ ÙÙ‚Ø·</option>
            <option value="data_entry">ğŸ“ Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª - Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„</option>
            <option value="accountant">ğŸ’° Ù…Ø­Ø§Ø³Ø¨ - Ø¥Ø¯Ø§Ø±Ø© Ù…Ø§Ù„ÙŠØ©</option>
            <option value="admin">âš™ï¸ Ù…Ø¯ÙŠØ± - ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©</option>
          </select>
          <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
            ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± Ù„Ø§Ø­Ù‚Ø§Ù‹
          </p>
        </div>

        <div className="flex justify-end gap-3 mt-6">
          <button
            type="button"
            onClick={onClose}
            className="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            Ø¥Ù„ØºØ§Ø¡
          </button>
          <button
            type="submit"
            className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
          >
            Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©
          </button>
        </div>
      </form>
    </Modal>
  );
};

// Modal ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙˆØ±
interface EditRoleModalProps {
  isOpen: boolean;
  onClose: () => void;
  employee: UserRoleInfo | null;
  onUpdate: (employeeId: string, newRole: string) => void;
}

const EditRoleModal: React.FC<EditRoleModalProps> = ({ isOpen, onClose, employee, onUpdate }) => {
  const [newRole, setNewRole] = useState('');

  useEffect(() => {
    if (employee) {
      setNewRole(employee.role);
    }
  }, [employee]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (employee) {
      onUpdate(employee.id, newRole);
    }
  };

  if (!employee) return null;

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙˆØ± Ø§Ù„Ù…ÙˆØ¸Ù">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
            Ø§Ù„Ù…ÙˆØ¸Ù: <strong>{employee.email || employee.userId}</strong>
          </p>
          <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>{newRole}</strong>
          </p>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
          </label>
          <select
            value={newRole}
            onChange={(e) => setNewRole(e.target.value)}
            className="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 p-2 rounded-md"
          >
            <option value="viewer">ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯ - Ø¹Ø±Ø¶ ÙÙ‚Ø·</option>
            <option value="data_entry">ğŸ“ Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª - Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„</option>
            <option value="accountant">ğŸ’° Ù…Ø­Ø§Ø³Ø¨ - Ø¥Ø¯Ø§Ø±Ø© Ù…Ø§Ù„ÙŠØ©</option>
            <option value="admin">âš™ï¸ Ù…Ø¯ÙŠØ± - ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©</option>
            <option value="owner">ğŸ‘‘ Ù…Ø§Ù„Ùƒ - ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„</option>
          </select>
        </div>

        <div className="flex justify-end gap-3 mt-6">
          <button
            type="button"
            onClick={onClose}
            className="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            Ø¥Ù„ØºØ§Ø¡
          </button>
          <button
            type="submit"
            className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
          >
            Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
          </button>
        </div>
      </form>
    </Modal>
  );
};

export default EmployeesPage;
